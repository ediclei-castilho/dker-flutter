version: 2
defaults: &defaults
  environment:
    PROJECT_TEST: odroidfeeder
    JS_SCRIPT_PATH: _scripts
    DELIVERED_APP_PATH: "PROJECT_TEST/build/app/outputs/apk/release/"
jobs:
  test:
    <<: *defaults
    docker:
      - image: rodolfoneto/dker-flutter:latest
    working_directory: ~/PROJECT_TEST
    steps:
      - checkout
      - run:
          name: "Flutter Test"
          command: |
            export
            ls -lrta
            cd $PROJECT_TEST
            flutter test
  build:
    <<: *defaults
    docker:
      - image: rodolfoneto/dker-flutter:latest
    working_directory: ~/PROJECT_TEST
    steps:
      - checkout
      - run:
          name: "Build"
          command: |
            cd $PROJECT_TEST
            flutter build apk
      - store_artifacts:
          path: odroidfeeder/build/app/outputs/apk/release/app-release.apk
      - persist_to_workspace:
          root: odroidfeeder/build/app/outputs/apk/release
          paths:
            - app-release.apk

  deploy:
    <<: *defaults
    docker:
      - image: node
    working_directory: ~/PROJECT_TEST
    steps:
      - checkout
      - attach_workspace:
        at: /tmp/workspace
      - run: |
          if [[ `ls /tmp/workspace/app-release.apk` ]]; then
            echo "It worked!"
          else
            echo "Nope!"
            exit 1
          fi
      #- run:
      #    name: "Deploy"
      #    command: |
      #      if [ "${CIRCLE_BRANCH}" == "develop" ]; then
              #incrementar versÃ£o corretamente
      #        npm install request
      #        node $JS_SCRIPT_PATH/upload-app.js ${DELIVERED_APP_PATH}app-release.apk app-release.apk
      #      fi
            
workflows:
  version: 2
  
  flutter_workflow:
    jobs:
      - test
      - build:
          requires:
            - test
      - deploy:
          requires:
            - build

