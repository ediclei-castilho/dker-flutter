version: 2.1
defaults: &defaults
  environment:
    PROJECT_TEST: odroidfeeder
    JS_SCRIPT_PATH: _scripts
    DELIVERED_APP_PATH: odroidfeeder/build/app/outputs/apk/release
only-releasable: &only-releasable
  filters:
    branches:
      only:
        - master
        - develop
        - release
only-non-release: &only-non-release
  filters:
    branches:
      ignore:
        - master
        - develop
        - release
jobs:
  test:
    <<: *defaults
    docker:
      - image: rodolfoneto/dker-flutter:latest
    working_directory: ~/PROJECT_TEST
    steps:
      - checkout
      - run:
          name: "Flutter Test"
          command: |
            export
            echo "$DELIVERED_APP_PATH"
            ls -lrta
            cd $PROJECT_TEST
            flutter test
  build:
    <<: *defaults
    docker:
      - image: rodolfoneto/dker-flutter:latest
    working_directory: ~/PROJECT_TEST
    steps:
      - checkout
      - run:
          name: "Build"
          command: |
            cd $PROJECT_TEST
            BUILD_NAME=`cat pubspec.yaml | awk '{sub(/\+[0-9].*/, "", $2);print $2}'`
            NUMBER=`cat pubspec.yaml | awk -F'+' '{print $2}'`
            BUILD_NUMBER=$((NUMBER++))
            arr=(${BUILD_NAME//./ })
            if [[ ${CIRCLE_BRANCH} != "develop" || ${CIRCLE_BRANCH} != "master" || ${CIRCLE_BRANCH} != "release" ]]; then
              ((arr[2]++))
              BUILD_NAME=$(echo "${arr[0]}.${arr[1]}.${arr[2]}")
              flutter build apk --build-name=${BUILD_NAME} --build-number=${BUILD_NUMBER}
            fi
      - store_artifacts:
          path: odroidfeeder/build/app/outputs/apk/release/app-release.apk
          destination: apk
      - persist_to_workspace:
          root: odroidfeeder/build/app/outputs/apk/release
          paths:
            - app-release.apk

  deploy:
    <<: *defaults
    docker:
      - image: node
    working_directory: ~/PROJECT_TEST
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: "Deploy"
          command: |
              #incrementar versÃ£o corretamente
              npm install request
              node $JS_SCRIPT_PATH/upload-app.js /tmp/workspace/app-release.apk app-release.apk
            
workflows:
  version: 2
  
  flutter_workflow:
    jobs:
      - test
      - build:
          requires:
            - test
      - deploy:
          <<: *only-releasable
          requires:
            - build
