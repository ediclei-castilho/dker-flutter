version: 2
environment:
  PROJECT_NAME: DB Job
  PROJECT_TEST: odroidfeeder
  JS_SCRIPT_PATH: _scripts
  DELIVERED_APP_PATH: "$PROJECT_TEST/build/app/outputs/apk/release/"
jobs:
  test:
    docker:
      - image: rodolfoneto/dker-flutter:latest
    working_directory: ~/odroidfeeder
    steps:
      - checkout
      - run:
          name: "Flutter Test"
          command: |
            ls -lrta
            echo ${CIRCLE_BRANCH}
            echo 'export PROJECT_TEST="odroidfeeder"' >> $BASH_ENV
            echo 'JS_SCRIPT_PATH="_scripts"' >> $BASH_ENV
            echo 'DELIVERED_APP_PATH="$PROJECT_TEST/build/app/outputs/apk/release/"' >> $BASH_ENV
            source $BASH_ENV
            cd $PROJECT_TEST
            flutter test
  build:
    docker:
      - image: rodolfoneto/dker-flutter:latest
    working_directory: ~/odroidfeeder
    steps:
      - checkout
      - run:
          name: "Build"
          command: |
            cd $PROJECT_TEST
            flutter build apk
      - store_artifacts:
          path: odroidfeeder/build/app/outputs/apk/release/app-release.apk

  deploy:
    docker:
      - image: node
    working_directory: ~/odroidfeeder
    steps:
      - chcekout
      - run:
          name: "Deploy"
          command: |
            if [ "${CIRCLE_BRANCH}" == "develop" ]; then
              #incrementar vers√£o corretamente
              cd $PROJECT_TEST
              flutter build apk
              npm install request
              node $JS_SCRIPT_PATH/upload-app.js ${DELIVERED_APP_PATH}app-release.apk app-release.apk
            fi
            
workflows:
  version: 2
  
  flutter_workflow:
    jobs:
      - test
      - build:
          requires:
            - test
      - deploy:
          requires:
            - build

